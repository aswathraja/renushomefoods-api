import{r as e,j as s,P as a,F as r,I as d,K as t,L as l}from"./vendor-react-Tc4xLtOv.js";import{A as i}from"./AdminNavBar-nV0t9olM.js";import{C as n}from"./dropdown-menu-Dweh6OYL.js";import{u as c,B as o,c as m,A as h,e as p,d as x}from"./index-CCl3TzR2.js";import{B as u}from"./badge-BZaNuTv-.js";import{C as j,a as v,b as N,c as y}from"./card-ZRElQZzO.js";import{D as g,a as f,b as _,c as b,e as w}from"./dialog-CT_0QHuT.js";import{I as $}from"./input-F4kRSedd.js";import{L as C}from"./label-DxpSIJ1C.js";import{T as k,a as F,b as P,c as S,d as A,e as X}from"./table-DDweQ1vw.js";import{C as q}from"./checkbox-C1BQOpNB.js";import{P as L,a as D,b as E}from"./popover-B3nRiRzT.js";import{S as I}from"./switch-adH75S8E.js";import"./vendor-charts-DKw1ZHYY.js";import"./vendor-ui-utils-B4kPJlQS.js";import"./TopBar-DKySbC2h.js";import"./vendor-radix-O0RUyoIw.js";import"./vendor-pdf-export-C4gp01y5.js";import"./vendor-animation-BGrdDg6I.js";const B=()=>{const{effectiveTheme:B}=c(),[U,z]=e.useState(!1),[O,R]=e.useState([]),[T,K]=e.useState([]),[J,M]=e.useState([]),[Q,V]=e.useState(""),[W,G]=e.useState(""),[H,Y]=e.useState(""),[Z,ee]=e.useState([]),[se,ae]=e.useState(!1),[re,de]=e.useState(null),[te,le]=e.useState({name:"",phone:"",email:"",password:""}),[ie,ne]=e.useState(!1),[ce,oe]=e.useState([]),[me,he]=e.useState({}),[pe,xe]=e.useState(!1),ue=e=>{if(!e)return"";let s=e.replace(/[^\d+\s]/g,"");if(s=s.replace(/\s+/g," ").trim(),s.includes("+")&&(s="+"+s.replace(/\+/g,"").trim()),s.startsWith("+")){const e=s.slice(1);if(-1!==e.indexOf(" ")){const s=e.split(" "),a=s[0].replace(/\D/g,"").slice(0,3),r=s.slice(1).join("").replace(/\D/g,"").slice(0,10);return r?`+${a} ${r}`:`+${a}`}const a=e.replace(/\D/g,""),r=a.slice(0,s.length>=11?2:3);return`+${r}${a.slice(r.length,r.length+10)}`}return s.replace(/\D/g,"").slice(0,10)},je=async()=>{try{const e=localStorage.getItem("token");if(!e)return void m.error("Authentication token not found");h.postData({endpoint:"/admin/users",body:{request:p({name:Q.trim()||null,phone:W.trim()||null,email:H.trim()||null,roles:Z.length>0?Z.map(e=>e.value):[]})},Authorization:`Bearer ${e}`,successCallback:e=>{R(e.users||[])},errorCallback:e=>{m.error("Failed to fetch users")}})}catch(e){m.error("Failed to fetch users")}};e.useEffect(()=>{je()},[Q,W,H,Z]),e.useEffect(()=>{(async()=>{try{const e=localStorage.getItem("token");if(!e)return void m.error("Authentication token not found");const s=await h.get("/admin/roles",{Authorization:`Bearer ${e}`});if(Array.isArray(s.roles)){const e=s.roles.map(e=>({label:e.name,value:e.id}));K(e)}else K([])}catch(e){m.error("Failed to fetch roles")}})()},[]);const ve=e=>{let{name:s,value:a}=e.target;"phone"===s&&(a=ue(a)),le({...te,[s]:a});const r={...me};"phone"===s&&(a.trim()?/^(\+\d{1,3}\s?\d{10}|\d{10})$/.test(a.trim())?delete r.phone:r.phone="Phone must be 10 digits or include country code like +91 1234567890":r.phone="Phone is required"),"email"===s&&(a.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a.trim())?delete r.email:r.email="Invalid email format":r.email="Email is required"),he(r)},Ne=(e,s,a)=>{let r=a;"pincode"===s&&(r=r.replace(/[^\d]/g,"").slice(0,6)),"phone"===s&&(r=ue(String(r)));const d=[...ce];d[e]={...d[e],[s]:r},oe(d);const t={...me};"phone"===s&&(r.trim()?/^(\+\d{1,3}\s?\d{10}|\d{10})$/.test(r.trim())?delete t[`address_phone_${e}`]:t[`address_phone_${e}`]="Phone must be 10 digits or include country code like +91 1234567890":t[`address_phone_${e}`]="Phone is required"),"pincode"===s&&(r.trim()?6!==r.length?t[`address_pincode_${e}`]="Pincode must be exactly 6 digits":delete t[`address_pincode_${e}`]:t[`address_pincode_${e}`]="Pincode is required"),he(t)};return s.jsxs(s.Fragment,{children:[s.jsx(i,{}),s.jsxs("div",{className:"container mx-auto mt-6 p-6 min-h-screen",children:[s.jsxs("div",{className:"flex justify-between items-center mb-6",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"Users"}),s.jsxs("div",{className:"flex gap-3",children:[s.jsxs(o,{variant:"outline",onClick:()=>{de(null),le({name:"",phone:"",email:"",password:""}),M([]),oe([{name:"",addressLine1:"",city:"",state:"",country:"",pincode:"",phone:"",isDefault:!0}]),he({}),ne(!1),ae(!0)},className:"border-green-600 text-green-600 hover:text-primary",children:[s.jsx(a,{className:"w-4 h-4 mr-2"})," Create User"]}),s.jsxs(o,{variant:"outline",onClick:()=>z(!U),className:"border-green-600 text-green-600 hover:text-primary",children:[s.jsx(r,{className:"w-4 h-4 mr-2"})," Filters"]})]})]}),U&&s.jsxs(j,{className:"mb-6",children:[s.jsx(v,{children:s.jsx(N,{children:"Filters"})}),s.jsx(y,{children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"name-filter",children:"Name"}),s.jsx($,{id:"name-filter",type:"text",value:Q,onChange:e=>V(e.target.value),placeholder:"Filter by name"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"phone-filter",children:"Phone"}),s.jsx($,{id:"phone-filter",type:"text",value:W,onChange:e=>G(e.target.value),placeholder:"Filter by phone"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"email-filter",children:"Email"}),s.jsx($,{id:"email-filter",type:"text",value:H,onChange:e=>Y(e.target.value),placeholder:"Filter by email"})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"roles-filter",children:"Roles"}),s.jsxs(L,{children:[s.jsx(D,{asChild:!0,children:s.jsx(o,{variant:"outline",role:"combobox","aria-expanded":!1,className:"w-full justify-between",children:Z.length>0?`${Z.length} role(s) selected`:"Filter by roles"})}),s.jsx(E,{className:"w-full p-0",align:"start",children:s.jsx("div",{className:"p-3 space-y-2",children:T.map(e=>s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(q,{id:`role-filter-${e.value}`,checked:Z.some(s=>s.value===e.value),onCheckedChange:s=>{const a=Z.some(s=>s.value===e.value);s&&!a?ee([...Z,e]):!s&&a&&ee(Z.filter(s=>s.value!==e.value))}}),s.jsx(C,{htmlFor:`role-filter-${e.value}`,className:"text-sm font-normal leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:e.label})]},e.value))})})]})]})]})})]}),s.jsx(j,{children:s.jsx(y,{className:"p-0",children:s.jsx("div",{className:"overflow-x-auto",children:s.jsxs(k,{children:[s.jsx(F,{children:s.jsxs(P,{children:[s.jsx(S,{className:"min-w-[200px]",children:"Name"}),s.jsx(S,{className:"min-w-[150px]",children:"Phone"}),s.jsx(S,{className:"min-w-[200px]",children:"Email"}),s.jsx(S,{className:"min-w-[250px]",children:"Roles"}),s.jsx(S,{className:"min-w-[200px]",children:"Address Name"}),s.jsx(S,{className:"min-w-[250px]",children:"Address Line 1"}),s.jsx(S,{className:"min-w-[150px]",children:"City"}),s.jsx(S,{className:"min-w-[150px]",children:"State"}),s.jsx(S,{className:"min-w-[150px]",children:"Country"}),s.jsx(S,{className:"min-w-[150px]",children:"Pincode"}),s.jsx(S,{className:"min-w-[150px]",children:"Address Phone"}),s.jsx(S,{className:"sticky right-0 bg-background",children:"Actions"})]})}),s.jsxs(A,{children:[O.map(e=>s.jsxs(P,{children:[s.jsx(X,{className:"font-medium",children:e.name}),s.jsx(X,{children:e.phone}),s.jsx(X,{children:e.email}),s.jsx(X,{children:e?.roles&&e?.roles?.length>0?s.jsx("div",{className:"flex flex-wrap gap-1",children:e?.roles.split(",").map((e,a)=>s.jsx(u,{variant:"secondary",className:"text-xs",children:e},a))}):s.jsx("span",{className:"text-primary text-sm",children:"No roles"})}),s.jsx(X,{children:e.addressName?e.addressName:"-"}),s.jsx(X,{children:e.addressLine1?e.addressLine1:"-"}),s.jsx(X,{children:e.city?e.city:"-"}),s.jsx(X,{children:e.state?e.state:"-"}),s.jsx(X,{children:e.country?e.country:"-"}),s.jsx(X,{children:e.pincode?e.pincode:"-"}),s.jsx(X,{children:e.addressPhone?e.addressPhone:"-"}),s.jsx(X,{className:"sticky right-0 bg-background",children:s.jsxs(o,{variant:"outline",size:"sm",onClick:()=>(async e=>{try{const s=localStorage.getItem("token");if(!s)return void m.error("Authentication token not found");h.postData({endpoint:"/admin/user-details",body:{request:p({token:s,userId:e.id,phone:e.phone,email:e.email})},Authorization:`Bearer ${s}`,successCallback:e=>{const s=e.user;de(s),le({id:s.id,name:s.name||"",phone:s.phone||"",email:s.email||"",password:""}),oe(s.UserAddresses||[]),ne(!1);const a=s.roles||[],r=T.filter(e=>a.some(s=>s.id===e.value));M(r),he({}),ae(!0)},errorCallback:e=>{}})}catch(s){m.error("Failed to fetch user details")}})(e),className:"border-primary text-primary",children:[s.jsx(d,{className:"text-primary w-4 h-4 mr-1"})," Edit"]})})]},e.id)),0===O.length&&s.jsx(P,{children:s.jsx(X,{colSpan:11,className:"text-center text-muted py-8",children:"No users found"})})]})]})})})}),s.jsx(g,{open:se,onOpenChange:ae,children:s.jsxs(f,{className:"max-w-4xl max-h-screen overflow-y-auto",children:[s.jsxs(_,{children:[s.jsx(b,{children:re?"Edit User":"Create User"}),s.jsx(w,{children:re?"Edit user information and addresses":"Create a new user with their information and addresses"})]}),s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"name",children:"Name"}),s.jsx($,{id:"name",type:"text",value:te.name,onChange:ve,name:"name",className:me.name?"border-red-500":"",placeholder:"Enter full name"}),me.name&&s.jsx("p",{className:"text-sm text-red-500",children:me.name})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"phone",children:"Phone"}),s.jsx($,{id:"phone",type:"text",value:te.phone,onChange:ve,name:"phone",className:me.phone?"border-red-500":"",placeholder:"Enter phone number"}),me.phone&&s.jsx("p",{className:"text-sm text-red-500",children:me.phone})]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"email",children:"Email"}),s.jsx($,{id:"email",type:"email",value:te.email,onChange:ve,name:"email",className:me.email?"border-red-500":"",placeholder:"Enter email address"}),me.email&&s.jsx("p",{className:"text-sm text-red-500",children:me.email})]}),re&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx(C,{children:"Password"}),s.jsx(I,{id:"resetPasswordSwitch",checked:ie,onCheckedChange:e=>{ne(e),e&&le(e=>({...e,password:""}))}}),s.jsx(C,{htmlFor:"resetPasswordSwitch",className:"text-sm font-normal",children:"Reset Password"})]}),ie&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"password",children:"New Password"}),s.jsx($,{id:"password",type:"password",value:te.password,onChange:ve,name:"password",className:me.password?"border-red-500":"",placeholder:"Enter password"}),me.password&&s.jsx("p",{className:"text-sm text-red-500",children:me.password})]})]}),!re&&s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"password",children:"Password"}),s.jsx($,{id:"password",type:"password",value:te.password,onChange:ve,name:"password",className:me.password?"border-red-500":"",placeholder:"Enter password",disabled:ie}),me.password&&s.jsx("p",{className:"text-sm text-red-500",children:me.password})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:"roles-select",children:"Roles"}),s.jsxs(L,{children:[s.jsx(D,{asChild:!0,children:s.jsx(o,{variant:"outline",role:"combobox","aria-expanded":!1,className:"w-full justify-between",children:J.length>0?`${J.length} role(s) selected`:"Select roles"})}),s.jsx(E,{className:"w-full p-0",align:"start",children:s.jsx("div",{className:"p-3 space-y-2",children:T.map(e=>s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(q,{id:`role-select-${e.value}`,checked:J.some(s=>s.value===e.value),onCheckedChange:s=>{const a=J.some(s=>s.value===e.value);s&&!a?M([...J,e]):!s&&a&&M(J.filter(s=>s.value!==e.value))}}),s.jsx(C,{htmlFor:`role-select-${e.value}`,className:"text-sm font-normal leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",children:e.label})]},e.value))})})]}),J.length>0&&s.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:J.map(e=>s.jsx(u,{variant:"secondary",className:"text-xs",children:e.label},e.value))})]}),s.jsxs("div",{className:"space-y-4",children:[s.jsxs("div",{className:"flex justify-between items-center",children:[s.jsx("h5",{className:"text-lg font-semibold",children:"Addresses"}),s.jsxs(o,{type:"button",variant:"outline",size:"sm",onClick:()=>{oe([...ce,{name:"",addressLine1:"",city:"",state:"",country:"",pincode:"",phone:"",isDefault:0===ce.length}])},"aria-label":"Add address",className:"border-primary-600 text-primary-600 hover:bg-primary/10",children:[s.jsx(a,{className:"w-4 h-4 mr-1"})," Add Address"]})]}),s.jsx("div",{className:"space-y-4",children:ce.map((e,a)=>s.jsxs(j,{className:"p-4",children:[s.jsxs("div",{className:"flex justify-between items-start mb-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsxs("span",{className:"font-medium",children:["Address ",a+1]}),e.isDefault&&s.jsx(u,{variant:"default",className:"bg-primary",children:"Default"})]}),s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(I,{id:`defaultAddress${a}`,checked:e.isDefault||!1,onCheckedChange:()=>(e=>{const s=ce.map((s,a)=>({...s,isDefault:a===e}));oe(s)})(a)}),s.jsx(C,{htmlFor:`defaultAddress${a}`,className:"text-sm font-normal",children:"Default"}),s.jsx(o,{type:"button",variant:"outline",size:"sm",onClick:()=>(e=>{const s=ce.filter((s,a)=>a!==e);oe(s)})(a),disabled:1===ce.length,"aria-label":`Delete address ${a+1}`,className:"border-red-600 text-red-600 hover:bg-red-50",children:s.jsx(t,{className:"w-4 h-4"})})]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:`address_name_${a}`,children:"Name"}),s.jsx($,{id:`address_name_${a}`,type:"text",value:e.name,onChange:e=>Ne(a,"name",e.target.value),className:me[`address_name_${a}`]?"border-red-500":"",placeholder:"Name"}),me[`address_name_${a}`]&&s.jsx("p",{className:"text-sm text-red-500",children:me[`address_name_${a}`]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:`address_phone_${a}`,children:"Phone"}),s.jsx($,{id:`address_phone_${a}`,type:"text",value:e.phone,onChange:e=>Ne(a,"phone",e.target.value),className:me[`address_phone_${a}`]?"border-red-500":"",placeholder:"Phone number"}),me[`address_phone_${a}`]&&s.jsx("p",{className:"text-sm text-red-500",children:me[`address_phone_${a}`]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:`address_pincode_${a}`,children:"Pincode"}),s.jsx($,{id:`address_pincode_${a}`,type:"text",value:e.pincode,onChange:e=>Ne(a,"pincode",e.target.value),className:me[`address_pincode_${a}`]?"border-red-500":"",placeholder:"6-digit pincode"}),me[`address_pincode_${a}`]&&s.jsx("p",{className:"text-sm text-red-500",children:me[`address_pincode_${a}`]})]}),s.jsxs("div",{className:"md:col-span-2 space-y-2",children:[s.jsx(C,{htmlFor:`address_addressLine1_${a}`,children:"Address Line 1"}),s.jsx($,{id:`address_addressLine1_${a}`,type:"text",value:e.addressLine1,onChange:e=>Ne(a,"addressLine1",e.target.value),className:me[`address_addressLine1_${a}`]?"border-red-500":"",placeholder:"Street address, building, etc."}),me[`address_addressLine1_${a}`]&&s.jsx("p",{className:"text-sm text-red-500",children:me[`address_addressLine1_${a}`]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:`address_city_${a}`,children:"City"}),s.jsx($,{id:`address_city_${a}`,type:"text",value:e.city,onChange:e=>Ne(a,"city",e.target.value),className:me[`address_city_${a}`]?"border-red-500":"",placeholder:"City"}),me[`address_city_${a}`]&&s.jsx("p",{className:"text-sm text-red-500",children:me[`address_city_${a}`]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:`address_state_${a}`,children:"State"}),s.jsx($,{id:`address_state_${a}`,type:"text",value:e.state,onChange:e=>Ne(a,"state",e.target.value),className:me[`address_state_${a}`]?"border-red-500":"",placeholder:"State"}),me[`address_state_${a}`]&&s.jsx("p",{className:"text-sm text-red-500",children:me[`address_state_${a}`]})]}),s.jsxs("div",{className:"space-y-2",children:[s.jsx(C,{htmlFor:`address_country_${a}`,children:"Country"}),s.jsx($,{id:`address_country_${a}`,type:"text",value:e.country,onChange:e=>Ne(a,"country",e.target.value),className:me[`address_country_${a}`]?"border-red-500":"",placeholder:"Country"}),me[`address_country_${a}`]&&s.jsx("p",{className:"text-sm text-red-500",children:me[`address_country_${a}`]})]})]})]},a))})]})]}),s.jsxs("div",{className:"flex justify-end space-x-2 pt-4 border-t",children:[s.jsx(o,{variant:"outline",onClick:()=>ae(!1),disabled:pe,children:"Close"}),s.jsx(o,{onClick:async()=>{if((()=>{const e={};return te.name.trim()||(e.name="Name is required"),te.phone.trim()?/^(\+\d{1,3}\s?\d{10}|\d{10})$/.test(te.phone.trim())||(e.phone="Phone must be 10 digits or include country code like +91 XX"):e.phone="Phone is required",te.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(te.email.trim())||(e.email="Invalid email format"):e.email="Email is required",re||ie||te.password.trim()||(e.password="Password is required"),ce.forEach((s,a)=>{s.name?.trim()||(e[`address_name_${a}`]="Address name is required"),s.addressLine1?.trim()||(e[`address_addressLine1_${a}`]="Address line 1 is required"),s.city?.trim()||(e[`address_city_${a}`]="City is required"),s.state?.trim()||(e[`address_staXte_${a}`]="State is required"),s.country?.trim()||(e[`address_country_${a}`]="Country is required"),s.pincode?.trim()?6!==s.pincode.length&&(e[`address_pincode_${a}`]="Pincode must be exactly 6 digits"):e[`address_pincode_${a}`]="Pincode is required",s.phone?.trim()?/^(\+\d{1,3}\s?\d{10}|\d{10})$/.test(s.phone.trim())||(e[`address_phone_${a}`]="Phone must be in the format +XX XXXXXXXXXX or XXXXXXXXXX"):e[`address_phone_${a}`]="Phone is required"}),he(e),0===Object.keys(e).length})()){xe(!0);try{const e=localStorage.getItem("token");if(!e)return m.error("Authentication token not found"),void xe(!1);const s={user:{id:te.id,name:te.name,phone:te.phone,email:te.email,password:te.password||"",resetPassword:ie,roles:J.map(e=>e.value)},addresses:ce};await h.postData({endpoint:"/admin/save-user",body:{request:p(s)},Authorization:`Bearer ${e}`,successCallback:e=>{const s=x(e);m.success(s.message||"User saved successfully"),ae(!1),je(),oe([]),ne(!1),le({name:"",phone:"",email:"",password:""}),de(null),M([]),he({})},errorCallback:e=>{m.error("Failed to save user")}})}catch(e){m.error("Failed to save user")}xe(!1)}else m.error("Please fix errors before submitting")},disabled:pe,className:"bg-primary text-white",children:pe?s.jsxs(s.Fragment,{children:[s.jsx(l,{className:"w-4 h-4 mr-2 animate-spin"}),"Saving..."]}):re?"Save Changes":"Create User"})]})]})})]}),s.jsx(n,{})]})};export{B as default};
